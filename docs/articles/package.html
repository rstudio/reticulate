<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using reticulate in an R Package • reticulate</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Using reticulate in an R Package">
<meta property="og:description" content="reticulate">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">reticulate</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.16-9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Using</li>
    <li>
      <a href="../articles/calling_python.html">Calling Python from R</a>
    </li>
    <li>
      <a href="../articles/r_markdown.html">R Markdown Python Engine</a>
    </li>
    <li>
      <a href="../articles/versions.html">Python Version Configuration</a>
    </li>
    <li>
      <a href="../articles/python_packages.html">Installing Python Packages</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Advanced</li>
    <li>
      <a href="../articles/arrays.html">Arrays in R and Python</a>
    </li>
    <li>
      <a href="../articles/package.html">Using reticulate in an R Package</a>
    </li>
    <li>
      <a href="../articles/python_dependencies.html">Managing an R Package's Python Dependencies</a>
    </li>
    <li class="divider">
    <li class="dropdown-header">Tools</li>
    <li>
      <a href="../articles/rstudio_ide.html">RStudio IDE Tools for reticulate</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rstudio/reticulate">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="package_files/jquery-1.11.3/jquery.min.js"></script><script src="package_files/elevate-section-attrs-2.0/elevate-section-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using reticulate in an R Package</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/rstudio/reticulate/blob/master/vignettes/package.Rmd"><code>vignettes/package.Rmd</code></a></small>
      <div class="hidden name"><code>package.Rmd</code></div>

    </div>

    
    
<div id="delay-loading-python-modules" class="section level2">
<h2 class="hasAnchor">
<a href="#delay-loading-python-modules" class="anchor"></a>Delay Loading Python Modules</h2>
<p>If you write an R package that wraps one or more Python packages, it’s likely that you’ll be importing Python modules within the <code>.onLoad</code> method of your package so that you can have convenient access to them within the rest of the package source code.</p>
<p>When you do this, you should use the <code>delay_load</code> flag to the <code><a href="../reference/import.html">import()</a></code> function, for example:</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="co"># global reference to scipy (will be initialized in .onLoad)</span>
<span class="va">scipy</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>

<span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">libname</span>, <span class="va">pkgname</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># use superassignment to update global reference to scipy</span>
  <span class="va">scipy</span> <span class="op">&lt;&lt;-</span> <span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="../reference/import.html">import</a></span><span class="op">(</span><span class="st">"scipy"</span>, delay_load <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<p>Using the <code>delay_load</code> flag has two important benefits:</p>
<ol style="list-style-type: decimal">
<li><p>It allows you to successfully load your package even when Python / Python packages are not installed on the target system (this is particularly important when testing on CRAN build machines).</p></li>
<li>
<p>It allows users to specify a desired location for Python before interacting with your package. For example:</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mypackage</span><span class="op">)</span>
<span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="../reference/use_python.html">use_virtualenv</a></span><span class="op">(</span><span class="st">"~/pythonenvs/userenv"</span><span class="op">)</span>
<span class="co"># call functions from mypackage</span></pre></div>
</li>
</ol>
<p>Without the <code>delay_load</code>, Python would be loaded immediately and the user’s call to <code>use_virtualenv</code> would have no effect.</p>
</div>
<div id="installing-python-dependencies" class="section level2">
<h2 class="hasAnchor">
<a href="#installing-python-dependencies" class="anchor"></a>Installing Python Dependencies</h2>
<p>Your R package likely depends on the installation of one or more Python packages. As a convenience to your users, you may want to provide a high-level R function to allow users to install these Python packages. It’s furthermore beneficial if multiple R packages that depend on Python packages install their dependencies in the same Python environment (so that they can be easily used together).</p>
<p>The <code><a href="../reference/py_install.html">py_install()</a></code> function provides a high-level interface for installing one or more Python packages. The packages will by default be installed within a virtualenv or Conda environment named “r-reticulate”. For example:</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/reticulate">reticulate</a></span><span class="op">)</span>
<span class="fu"><a href="../reference/py_install.html">py_install</a></span><span class="op">(</span><span class="st">"scipy"</span><span class="op">)</span></pre></div>
<p>You can document the use of this function along with your package or alternatively provide a wrapper function for <code><a href="../reference/py_install.html">py_install()</a></code>. For example:</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="va">install_scipy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">method</span> <span class="op">=</span> <span class="st">"auto"</span>, <span class="va">conda</span> <span class="op">=</span> <span class="st">"auto"</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">reticulate</span><span class="fu">::</span><span class="fu"><a href="../reference/py_install.html">py_install</a></span><span class="op">(</span><span class="st">"scipy"</span>, method <span class="op">=</span> <span class="va">method</span>, conda <span class="op">=</span> <span class="va">conda</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<p>While reticulate is capable of binding to <a href="calling_python.html#python-version">any Python environment</a> available on a system, it’s much more straightforward for users if there is a common environment used by R packages with convenient high-level functions provided for installation. We therefore strongly recommend that R package developers use the approach described here.</p>
</div>
<div id="checking-and-testing-on-cran" class="section level2">
<h2 class="hasAnchor">
<a href="#checking-and-testing-on-cran" class="anchor"></a>Checking and Testing on CRAN</h2>
<p>If you use <strong>reticulate</strong> in another R package you need to account for the fact that when your package is submitted to CRAN, the CRAN test servers may not have Python, NumPy, or whatever other Python modules you are wrapping in your package. If you don’t do this then your package may fail to load and/or pass its tests when run on CRAN.</p>
<p>There are two things you should do to ensure your package is well behaved on CRAN:</p>
<ol style="list-style-type: decimal">
<li>
<p>Use the <code>delay_load</code> option (as described above) to ensure that the module (and Python) is loaded only on its first use. For example:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="co"># python 'scipy' module I want to use in my package</span>
<span class="va">scipy</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>

<span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">libname</span>, <span class="va">pkgname</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># delay load foo module (will only be loaded when accessed via $)</span>
  <span class="va">scipy</span> <span class="op">&lt;&lt;-</span> <span class="fu"><a href="../reference/import.html">import</a></span><span class="op">(</span><span class="st">"scipy"</span>, delay_load <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">}</span></pre></div>
</li>
<li>
<p>When writing tests, check to see if your module is available and if it isn’t then skip the test. For example, if you are using the <strong>testthat</strong> package, you might do this:</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="co"># helper function to skip tests if we don't have the 'foo' module</span>
<span class="va">skip_if_no_scipy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">have_scipy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/py_module_available.html">py_module_available</a></span><span class="op">(</span><span class="st">"scipy"</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">have_scipy</span><span class="op">)</span>
    <span class="fu">skip</span><span class="op">(</span><span class="st">"scipy not available for testing"</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># then call this function from all of your tests</span>
<span class="fu">test_that</span><span class="op">(</span><span class="st">"Things work as expected"</span>, <span class="op">{</span>
  <span class="fu">skip_if_no_scipy</span><span class="op">(</span><span class="op">)</span>
  <span class="co"># test code here...</span>
<span class="op">}</span><span class="op">)</span></pre></div>
</li>
</ol>
</div>
<div id="implementing-s3-methods" class="section level2">
<h2 class="hasAnchor">
<a href="#implementing-s3-methods" class="anchor"></a>Implementing S3 Methods</h2>
<p>Python objects exposed by <strong>reticulate</strong> carry their Python classes into R, so it’s possible to write S3 methods to customize e.g. the <code>str</code> or <code>print</code> behavior for a given class (note that it’s not typically necessary that you do this since the default <code>str</code> and <code>print</code> methods call <code>PyObject_Str</code>, which typically provides an acceptable default behavior).</p>
<p>If you do decide to implement custom S3 methods for a Python class it’s important to keep in mind that when an R session ends the connection to Python objects is lost, so when the .RData saved from one R session is restored in a subsequent R session the Python objects are effectively lost (technically they become <code>NULL</code> R <code>externalptr</code> objects).</p>
<p>By default when you attempt to interact with a Python object from a previous session (a <code>NULL</code> R <code>externalptr</code>) an error is thrown. If you want to do something more customized in your S3 method you can use the <code><a href="../reference/py_is_null_xptr.html">py_is_null_xptr()</a></code> function. For example:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>method.MyModule.MyPythonClass &lt;-<span class="st"> </span><span class="cf">function</span>(x, y, ...) {</span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="cf">if</span> (<span class="kw">py_is_null_xptr</span>(x))</span>
<span id="cb7-3"><a href="#cb7-3"></a>    <span class="co"># whatever is appropriate</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>  <span class="cf">else</span> </span>
<span id="cb7-5"><a href="#cb7-5"></a>    <span class="co"># interact with the object</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>}</span></code></pre></div>
<p>Note that this check isn’t required, as by default an R error will occur. If it’s desirable to avoid this error for any reason then you can use <code><a href="../reference/py_is_null_xptr.html">py_is_null_xptr()</a></code> to do so.</p>
<p>The <strong>reticulate</strong> package exports a <code>py_str</code> generic method which is called from the <code>str</code> method only after doing appropriate validation (if the object is NULL then <code>&lt;pointer: 0x0&gt;</code> is returned). You can implement the <code>py_str</code> method as follows:</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="co">#' @importFrom reticulate py_str</span>
<span class="co">#' @export </span>
<span class="va">py_str.MyModule.MyPythonClass</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># interact with the object to generate the string</span>
<span class="op">}</span></pre></div>
<p>The <code>print</code> and <code>summary</code> methods for Python objects both call the <code>str</code> method by default, so if you implement <code><a href="../reference/py_str.html">py_str()</a></code> you will automatically inherit implementations for those methods.</p>
<div id="converting-between-r-and-python" class="section level3">
<h3 class="hasAnchor">
<a href="#converting-between-r-and-python" class="anchor"></a>Converting between R and Python</h3>
<p><strong>reticulate</strong> provides the generics <code><a href="../reference/r-py-conversion.html">r_to_py()</a></code> for converting R objects into Python objects, and <code><a href="../reference/r-py-conversion.html">py_to_r()</a></code> for converting Python objects back into R objects. Package authors can provide methods for these generics to convert Python and R objects otherwise not handled by <strong>reticulate</strong>.</p>
<p><strong>reticulate</strong> provides conversion operators for some of the most commonly used Python objects, including:</p>
<ul>
<li>Built-in Python objects (lists, dictionaries, numbers, strings, tuples)</li>
<li>NumPy arrays,</li>
<li>Pandas objects (<code>Index</code>, <code>Series</code>, <code>DataFrame</code>),</li>
<li>Python <code>datetime</code> objects.</li>
</ul>
<p>If you see that <strong>reticulate</strong> is missing support for conversion of one or more objects from these packages, please <a href="https://github.com/rstudio/reticulate/issues">let us know</a> and we’ll try to implement the missing converter. For Python packages not in this set, you can provide conversion operators in your own extension package.</p>
</div>
<div id="writing-your-own-r_to_py-methods" class="section level3">
<h3 class="hasAnchor">
<a href="#writing-your-own-r_to_py-methods" class="anchor"></a>Writing your own <code>r_to_py()</code> methods</h3>
<p><code><a href="../reference/r-py-conversion.html">r_to_py()</a></code> accepts a <code>convert</code> argument, which controls how objects generated from the created Python object are converted. To illustrate, consider the difference between these two cases:</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/reticulate">reticulate</a></span><span class="op">)</span>

<span class="co"># [convert = TRUE] =&gt; convert Python objects to R when appropriate</span>
<span class="va">sys</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/import.html">import</a></span><span class="op">(</span><span class="st">"sys"</span>, convert <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">sys</span><span class="op">$</span><span class="va">path</span><span class="op">)</span>
<span class="co"># [1] "character"</span>

<span class="co"># [convert = FALSE] =&gt; always return Python objects</span>
<span class="va">sys</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/import.html">import</a></span><span class="op">(</span><span class="st">"sys"</span>, convert <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">sys</span><span class="op">$</span><span class="va">path</span><span class="op">)</span>
<span class="co"># [1] "python.builtin.list" "python.builtin.object"</span></pre></div>
<p>This is accomplished through the use of a <code>convert</code> flag, which is set on the Python object wrappers used by <code>reticulate</code>. Therefore, if you’re writing a method <code>r_to_py.foo()</code> for an object of class <code>foo</code>, you should take care to preserve the <code>convert</code> flag on the generated object. This is typically done by:</p>
<ol style="list-style-type: decimal">
<li><p>Passing <code>convert</code> along to the appropriate lower-level <code><a href="../reference/r-py-conversion.html">r_to_py()</a></code> method;</p></li>
<li><p>Explicitly setting the <code>convert</code> attribute on the returned Python object.</p></li>
</ol>
<p>As an example of the second:</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="co"># suppose 'make_python_object()' creates a Python object</span>
<span class="co"># from R objects of class 'my_r_object'.</span>
<span class="va">r_to_py.my_r_object</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">convert</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">object</span> <span class="op">&lt;-</span> <span class="fu">make_python_object</span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/assign.html">assign</a></span><span class="op">(</span><span class="st">"convert"</span>, <span class="va">convert</span>, envir <span class="op">=</span> <span class="va">object</span><span class="op">)</span>
  <span class="va">object</span>
<span class="op">}</span></pre></div>
</div>
</div>
<div id="using-travis-ci" class="section level2">
<h2 class="hasAnchor">
<a href="#using-travis-ci" class="anchor"></a>Using Travis-CI</h2>
<p><a href="https://travis-ci.org/">Travis-CI</a> is a commonly used platform for continuous integration and testing of R packages. Making it work with <strong>reticulate</strong> is pretty simple - all you need to do is add a <code>before_install</code> section to a standard R <code>.travis.yml</code> file that asks Travis to guarantee the testing machine has <code>numpy</code> (which <strong>reticulate</strong> depends on) and any Python modules you’re interacting with that don’t ship with the language itself:</p>
<pre><code>before_install:
  - pip install numpy any_other_dependencies go_here</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Kevin Ushey, JJ Allaire, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>, Yuan Tang.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
